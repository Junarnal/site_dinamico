<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Formul√°rio de Inscri√ß√£o</title>
  <link rel="stylesheet" href="style_form.css">

</head>
<body>
  <header>
    <div class="container-header">
      <h1>Instituto Federal de Mato Grosso do Sul</h1>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    <div class="form active">
      <h1>Formul√°rio de Inscri√ß√£o</h1>
      <div class="tabs">
        <div class="tab active" id="tab-aba_dados_pessoais">1. Dados Pessoais</div>
        <div class="tab disabled" id="tab-aba_endereco">2. Endere√ßo</div>
        <div class="tab disabled" id="tab-aba_curso">3. Curso</div>
      </div>

      <form method="POST" id="formulario" novalidate>
        <!-- Aba Dados Pessoais -->
        <div id="aba_dados_pessoais" class="tab-content active">
          <div class="form-row">
            <label for="nome">Nome completo <span style="color: red;">*</span></label>
            <input type="text" id="nome" name="inscrito_nome" required>
          </div>

          <div class="form-row">
            <label for="cpf">CPF <span style="color: red;">*</span></label>
            <input type="text" id="cpf" name="inscrito_cpf" pattern="^[0-9]{3}(.?)[0-9]{3}(.?)[0-9]{3}(-?)[0-9]{2}" required>
          </div>

          <div class="form-row">
            <label for="data_nascimento">Data de nascimento <span style="color: red;">*</span></label>
            <input type="date" id="data_nascimento" name="inscrito_data_nasc" style="max-width: 180px;" required>
          </div>

          <div class="form-row">
            <label for="sexo">Sexo <span style="color: red;">*</span></label>
            <select id="sexo" name="inscrito_sexo" required>
              <option value="">-- Selecione um sexo --</option>
              <option value="Masculino">Masculino</option>
              <option value="Feminino">Feminino</option>
            </select>
          </div>

          <div class="form-row">
            <label for="rg">RG</label>
            <input type="text" id="rg" name="inscrito_rg">
          </div>

          <div class="form-row">
            <label for="rg_expedidor">Org√£o Expedidor</label>
            <input type="text" id="rg_expedidor" name="inscrito_rg_expedidor">
          </div>

          <div class="form-row">
            <label for="estado_civil">Estado civil <span style="color: red;">*</span></label>
            <select id="estado_civil" name="inscrito_estado_civil" required>
              <option value="">-- Escolha um estado civil --</option>
              <option value="Solteiro(a)">Solteiro(a)</option>
              <option value="Casado(a)">Casado(a)</option>
              <option value="Divorciado(a)">Divorciado(a)</option>
              <option value="Viuvo(a)">Vi√∫vo(a)</option>
            </select>
          </div>

          <div class="form-row">
            <label for="nome_mae">Nome da m√£e <span style="color: red;">*</span></label>
            <input type="text" id="nome_mae" name="inscrito_nome_mae" required>
          </div>

          <div class="form-row">
            <label for="nome_pai">Nome do pai:</label>
            <input type="text" id="nome_pai" name="inscrito_nome_pai">
          </div>

          <div class="layout-button">
            <button type="button" onclick="avancarAba('aba_dados_pessoais', 'aba_endereco')">Pr√≥ximo</button>
          </div>
        </div>

        <!-- Aba Endere√ßo -->
        <div id="aba_endereco" class="tab-content">
          <div class="form-row">
            <label for="celular">Celular <span style="color: red;">*</span></label>
            <input type="tel" id="celular" name="inscrito_celular" placeholder="(67) 99999-9999" pattern="^(\([0-9]{2}\)|[0-9]{2})(\s?)[0-9]{5}(-?)[0-9]{4}" required>
          </div>

          <div class="form-row">
            <label for="email">Email <span style="color: red;">*</span></label>
            <input type="email" id="email" name="inscrito_email" placeholder="exemplo@email.com" required>
          </div>

          <div class="form-row">
            <label for="cep">CEP <span style="color: red;">*</span></label>
            <input type="text" id="cep" name="inscrito_cep" pattern="^[0-9]{5}(.?)[0-9]{2}" required>
          </div>

          <div class="form-row">
            <label for="logradouro">Logradouro <span style="color: red;">*</span></label>
            <input type="text" id="logradouro" name="inscrito_logradouro" required>
          </div>

          <div class="form-row">
            <label for="numero_endereco">N√∫mero <span style="color: red;">*</span></label>
            <input type="text" id="numero_endereco" name="inscrito_numero_endereco" required>
          </div>

          <div class="form-row">
            <label for="bairro">Bairro <span style="color: red;">*</span></label>
            <input type="text" id="bairro" name="inscrito_bairro" required>
          </div>

          <div class="form-row">
            <label for="complemento">Complemento</label>
            <input type="text" id="complemento" name="inscrito_complemento">
          </div>

          <div class="form-row">
            <label for="cidade">Cidade <span style="color: red;">*</span></label>
            <input type="text" id="cidade" name="inscrito_cidade" required>
          </div>

          <div class="form-row">
            <label for="estado">Estado <span style="color: red;">*</span></label>
            <select id="estado" name="inscrito_estado" required>
              <option value="">-- Estado --</option>
              <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
              <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
              <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
              <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
              <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
              <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
              <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
              <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
              <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
            </select>
          </div>

          <div class="layout-button">
            <button type="button" onclick="voltarAba('aba_endereco', 'aba_dados_pessoais')">Voltar</button>
            <button type="button" onclick="avancarAba('aba_endereco', 'aba_curso')">Pr√≥ximo</button>
          </div>
        </div>

        <!-- Aba Curso -->
        <div id="aba_curso" class="tab-content">
          <div class="form-row">
            <label for="curso">Escolha seu curso <span style="color: red;">*</span></label>
            <select id="curso" name="inscrito_curso" required>
              <option value="">-- Selecione um curso --</option>
              <option value="Inform√°tica">Inform√°tica</option>
              <option value="Eletrot√©cnica">Eletrot√©cnica</option>
            </select>
          </div>

          <div class="form-row">
            <label for="turno">Escolha seu turno <span style="color: red;">*</span></label>
            <select id="turno" name="inscrito_turno" required>
              <option value="">-- Selecione um turno --</option>
              <option value="Matutino">Matutino</option>
              <option value="Vespertino">Vespertino</option>
            </select>
          </div>

          <div class="layout-button">
            <button type="button" onclick="voltarAba('aba_curso', 'aba_endereco')">Voltar</button>
            <button type="submit">Enviar</button>
          </div>
        </div>
      </form>
      <div id="mensagem-sucesso" style="display: none; text-align: center; margin-top: 30px;">
        <h2 style="color: green;">‚úÖ Inscri√ß√£o realizada com sucesso!</h2>
        <a href="relatorio.php" class="botao-relatorio" style="
          display: inline-block;
          margin-top: 15px;
          padding: 10px 20px;
          background-color: #0b671a;
          color: white;
          text-decoration: none;
          border-radius: 6px;
          font-weight: bold;
        ">üìÑ Ver inscritos</a>
      </div>
    </div>
  </div>

  <script>
let formularioEnviado = false;
document.getElementById('formulario').addEventListener('submit', async function (e) {
  e.preventDefault();

  if (formularioEnviado) {
    // Mensagem simples para segundo envio
    alert('‚ùó O formul√°rio j√° foi enviado. Voc√™ n√£o pode enviar novamente.');
    return;
  }

  if (!validarCampos('aba_curso')) return;

  const formData = new FormData(this);

  try {
    const resposta = await fetch('insert.php', {
      method: 'POST',
      body: formData
    });

    const json = await resposta.json();

    if (json.status === 'ok') {
      formularioEnviado = true; // impede novo envio
      document.querySelector('.form').innerHTML = `
        <div style="text-align: center; margin-top: 30px;">
          <h2 style="color: green;">‚úÖ Inscri√ß√£o realizada com sucesso!</h2>
          <a href="relatorio.php" class="botao-relatorio" style="
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #0b671a;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
          ">üìÑ Ver inscritos</a>
        </div>
      `;
    } else {
      alert('‚ùó ' + json.mensagem);
    }
  } catch (err) {
    console.error('Erro na requisi√ß√£o:', err);
    alert('Erro inesperado. Verifique sua conex√£o ou tente mais tarde.');
  }
});




    const abas = ['aba_dados_pessoais', 'aba_endereco', 'aba_curso'];

    // Mostrar aba e ativar tab se n√£o desabilitada
    function mostrarAba(nomeAba) {
  const indexAba = abas.indexOf(nomeAba);
  const abaAtualAtiva = document.querySelector('.tab-content.active');
  const indexAtual = abas.indexOf(abaAtualAtiva?.id);

  // Se for tentativa de avan√ßar para aba seguinte sem valida√ß√£o
  if (indexAba > indexAtual) {
    if (!validarCampos(abas[indexAtual])) return;
    liberarAba(nomeAba);
  }

  // Troca de aba (permitido voltar livremente)
  document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

  document.getElementById(nomeAba).classList.add('active');
  document.getElementById('tab-' + nomeAba).classList.add('active');
}



    // Avan√ßa para a pr√≥xima aba se a atual for v√°lida
    function avancarAba(abaAtual, abaProxima) {
      if (!validarCampos(abaAtual)) return;
      liberarAba(abaProxima);
      mostrarAba(abaProxima);
    }

    // Volta para aba anterior
    function voltarAba(abaAtual, abaAnterior) {
      mostrarAba(abaAnterior);
    }

    // Valida todos campos required da aba
    function validarCampos(aba) {
      const campos = document.querySelectorAll(`#${aba} [required]`);
      for (let campo of campos) {
        if (!campo.checkValidity()) {
          campo.reportValidity();
          return false;
        }
      }
      return true;
    }

    // Habilita aba
    function liberarAba(nomeAba) {
      const tab = document.getElementById('tab-' + nomeAba);
      tab.classList.remove('disabled');
      tab.classList.add('enabled');
    }

    // Desabilita aba
    function desabilitarAba(nomeAba) {
      const tab = document.getElementById('tab-' + nomeAba);
      tab.classList.add('disabled');
      tab.classList.remove('enabled');
    }

    function validarAbaDinamica(abaAtual, abaProxima) {
  if (validarCampos(abaAtual)) {
    liberarAba(abaProxima);
  } else {
    desabilitarAba(abaProxima);

    // Se aba ativa for a abaProxima que ficou inv√°lida, volta para abaAtual
    const abaAtiva = document.querySelector('.tab-content.active').id;
    if (abaAtiva === abaProxima) {
      const activeElement = document.activeElement;
      if (activeElement && activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
        mostrarAba(abaAtual);
      }
    }
  }
}

    document.getElementById('cep').addEventListener('blur', async () => {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if (cep.length !== 8) return;

    try {
      const resposta = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
      const dados = await resposta.json();

      if (!dados.erro) {
        document.getElementById('logradouro').value = dados.logradouro || '';
        document.getElementById('bairro').value = dados.bairro || '';
        document.getElementById('cidade').value = dados.localidade || '';
        document.getElementById('estado').value = dados.uf || '';
      }
    } catch (e) {
      console.error("Erro ao buscar CEP:", e);
    }
  });

  document.querySelector('.tabs').addEventListener('click', function (e) {
  const tab = e.target.closest('.tab');
  if (!tab || tab.classList.contains('disabled')) return;

  const idAba = tab.id.replace('tab-', '');
  mostrarAba(idAba);
});

window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const cursoSelecionado = params.get('curso');

    if (cursoSelecionado) {
      const select = document.getElementById('curso');
      if (select) {
        for (let option of select.options) {
          if (option.value === cursoSelecionado) {
            select.value = cursoSelecionado;
            break;
          }
        }
      }
    }
  });

  </script>
</body>
</html>
